# Spring Cloud Config 配置动态刷新指南

## 一、功能说明

通过 Spring Cloud Config 和 Actuator，实现**不重启应用**即可刷新配置的功能。

## 二、已完成配置

### 1. 依赖配置
```xml
<!-- pom.xml -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

### 2. Actuator 端点配置
```yaml
# application.yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh,health,info,env
      base-path: /actuator
  endpoint:
    refresh:
      enabled: true
```

### 3. 配置类示例
已创建 `DynamicConfig.java`，展示如何使用 `@RefreshScope` 注解。

## 三、使用步骤

### 步骤 1: 标记需要刷新的 Bean

在需要动态刷新配置的类上添加 `@RefreshScope` 注解：

```java
@Component
@RefreshScope  // 关键注解
public class YourConfigClass {
    
    @Value("${your.config.key}")
    private String configValue;
    
    // getter 方法
}
```

**重要提示**：
- ✅ 只有标注了 `@RefreshScope` 的 Bean 才会动态刷新
- ✅ `@ConfigurationProperties` 类也会自动刷新（不需要 `@RefreshScope`）
- ❌ 普通的 `@Value` 注入不会自动刷新

### 步骤 2: 在 Config Server 中修改配置

修改 Config Server 中的配置文件，例如：
```yaml
# akm-springboot3-dev.yaml
akm:
  cacheType: redis  # 从 local 改为 redis
  enabledAuth: false  # 从 true 改为 false
```

### 步骤 3: 触发配置刷新

#### 方式一：使用 curl 命令（推荐）

```bash
curl -X POST http://localhost:33000/actuator/refresh
```

#### 方式二：使用 Postman 或其他 HTTP 客户端

```
POST http://localhost:33000/actuator/refresh
Content-Type: application/json
```

#### 响应示例

```json
[
  "config.client.version",
  "akm.cacheType",
  "akm.enabledAuth"
]
```

返回的是发生变化的配置项列表。

### 步骤 4: 验证配置已刷新

#### 方式一：访问测试接口

```bash
curl http://localhost:33000/demo/config/open/refresh-test
```

#### 方式二：查看应用日志

如果在配置类中记录了日志，会看到类似输出：

```
========================================
配置已刷新:
缓存类型: redis
启用权限校验: false
========================================
```

## 四、配置刷新范围

### ✅ 会刷新的配置

1. **标注 `@RefreshScope` 的 Bean**
   ```java
   @Component
   @RefreshScope
   public class MyConfig {
       @Value("${my.config}")
       private String config;
   }
   ```

2. **`@ConfigurationProperties` 绑定的配置类**
   ```java
   @Component
   @ConfigurationProperties(prefix = "akm")
   public class AkmConfig {
       private String cacheType;
       // getter/setter
   }
   ```

3. **日志级别**
   ```yaml
   logging:
     level:
       com.akm: DEBUG  # 可以动态调整日志级别
   ```

### ❌ 不会刷新的配置

1. **数据源配置** (DataSource)
   - 需要重启应用

2. **服务器端口** (server.port)
   - 需要重启应用

3. **普通 `@Value` 注入**（没有 `@RefreshScope`）
   ```java
   @Component
   public class StaticConfig {
       @Value("${my.config}")
       private String config;  // 不会刷新
   }
   ```

4. **`@PostConstruct` 初始化的值**
   - 只在 Bean 创建时执行一次

## 五、已实现的功能

### 1. DynamicConfig.java
动态配置类，包含常用的 akm 配置项：
- `akm.cacheType` - 缓存类型
- `akm.enabledAuth` - 是否启用权限
- `akm.enableLoginCaptcha` - 是否启用验证码
- `akm.forcePasswordChange` - 是否强制修改密码
- `akm.enabledCorsAllow` - 是否启用跨域
- `akm.enabledEncrypt` - 是否启用加解密
- `akm.enabledSign` - 是否启用签名
- `akm.enabledApiFreq` - 是否启用频率限制

### 2. 测试接口
- `GET /demo/config/open/info` - 查看配置来源
- `GET /demo/config/open/refresh-test` - 查看动态配置当前值
- `POST /demo/config/open/trigger-refresh-log` - 触发配置日志记录

### 3. Actuator 端点
- `POST /actuator/refresh` - 刷新配置
- `GET /actuator/health` - 健康检查
- `GET /actuator/info` - 应用信息
- `GET /actuator/env` - 环境变量

## 六、最佳实践

### 1. 在需要动态刷新的类上使用 @RefreshScope

```java
@Service
@RefreshScope
public class BusinessService {
    
    @Value("${business.threshold}")
    private Integer threshold;
    
    public void doSomething() {
        // 使用 threshold，刷新后会使用新值
    }
}
```

### 2. 使用 @ConfigurationProperties 而不是 @Value

```java
@Component
@ConfigurationProperties(prefix = "akm")
@Getter
@Setter
public class AkmProperties {
    private String cacheType;
    private Boolean enabledAuth;
    // 自动刷新，不需要 @RefreshScope
}
```

### 3. 配置刷新监听

```java
@Component
public class ConfigRefreshListener {
    
    @EventListener
    public void onRefresh(RefreshScopeRefreshedEvent event) {
        log.info("配置已刷新: {}", event.getName());
        // 执行刷新后的业务逻辑
    }
}
```

### 4. 批量刷新多个实例

如果有多个应用实例，需要对每个实例都发送刷新请求：

```bash
# 实例 1
curl -X POST http://server1:33000/actuator/refresh

# 实例 2
curl -X POST http://server2:33000/actuator/refresh
```

**推荐**：使用 Spring Cloud Bus 实现配置的自动广播刷新。

## 七、使用 Spring Cloud Bus（可选）

如果需要自动广播配置刷新到所有实例，可以集成 Spring Cloud Bus：

### 1. 添加依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bus-amqp</artifactId>
</dependency>
```

### 2. 配置 RabbitMQ

```yaml
spring:
  rabbitmq:
    host: localhost
    port: 5672
    username: guest
    password: guest

management:
  endpoints:
    web:
      exposure:
        include: refresh,health,info,env,busrefresh
```

### 3. 触发全局刷新

```bash
# 只需调用一次，所有实例都会刷新
curl -X POST http://any-instance:33000/actuator/busrefresh
```

## 八、故障排查

### 问题 1: 配置没有刷新

**排查步骤**：
1. 检查类是否标注了 `@RefreshScope`
2. 检查 `/actuator/refresh` 是否返回了配置项列表
3. 检查 Config Server 中的配置是否真的修改了
4. 查看应用日志是否有错误信息

### 问题 2: /actuator/refresh 返回 404

**解决方案**：
```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh  # 确保包含 refresh
```

### 问题 3: 配置刷新后业务逻辑没有生效

**原因**：
- Bean 在初始化时缓存了配置值
- 使用了 `@PostConstruct` 初始化

**解决方案**：
- 每次使用时重新读取配置值
- 或监听 `RefreshScopeRefreshedEvent` 事件重新初始化

## 九、安全建议

### 1. 生产环境应启用端点安全

```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh,health
  endpoint:
    refresh:
      enabled: true
spring:
  security:
    user:
      name: admin
      password: your-secure-password
```

### 2. 限制访问来源

```yaml
management:
  server:
    port: 8081  # 使用不同端口
    address: 127.0.0.1  # 只允许本地访问
```

### 3. 使用 HTTPS

生产环境建议使用 HTTPS 保护 Actuator 端点。

## 十、完整示例

### 1. 修改 Config Server 配置

```yaml
# akm-springboot3-dev.yaml (在 Config Server 中)
akm:
  cacheType: redis
  enabledAuth: false
```

### 2. 刷新配置

```bash
curl -X POST http://localhost:33000/actuator/refresh
```

### 3. 验证结果

```bash
curl http://localhost:33000/demo/config/open/refresh-test

# 响应
{
  "message": "当前配置值（可通过 POST /actuator/refresh 刷新）",
  "dynamicConfigs": {
    "cacheType": "redis",
    "enabledAuth": false
  }
}
```

## 十一、相关文档

- [Spring Cloud Config 官方文档](https://docs.spring.io/spring-cloud-config/docs/current/reference/html/)
- [Spring Boot Actuator 文档](https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html)
- [RefreshScope 说明](https://docs.spring.io/spring-cloud-commons/docs/current/reference/html/#refresh-scope)

