# 缓存配置说明

## 一、概述

系统支持两种缓存方式：
- **本地缓存（LocalCache）**: 基于 ConcurrentHashMap 的本地内存缓存
- **Redis 缓存**: 基于 Redis 的分布式缓存

通过配置 `akm.cacheType` 可以灵活切换缓存方式。

## 二、配置方式

### 方式一：使用本地缓存（开发环境推荐）

```yaml
# application-dev.yaml
akm:
  cacheType: local  # 使用本地内存缓存

# 不需要配置 spring.data.redis
```

**特点**：
- ✅ 无需外部依赖
- ✅ 响应速度快
- ✅ 开发调试方便
- ❌ 不支持分布式
- ❌ 应用重启后数据丢失

### 方式二：使用 Redis 缓存（生产环境推荐）

```yaml
# application-prod.yaml
akm:
  cacheType: redis  # 使用 Redis 缓存

spring:
  data:
    redis:
      host: 127.0.0.1
      port: 6379
      password: Redis@1234
      database: 0
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: -1ms
```

**特点**：
- ✅ 支持分布式
- ✅ 数据持久化
- ✅ 支持集群
- ❌ 需要 Redis 服务
- ❌ 网络延迟

## 三、缓存工具类

### 3.1 CacheUtils（对象缓存）

```java
// 设置缓存
CacheUtils.set("user:1", userObject);
CacheUtils.set("user:1", userObject, 3600); // 带过期时间(秒)

// 获取缓存
User user = CacheUtils.get("user:1");

// 删除缓存
CacheUtils.del("user:1");

// 批量删除
CacheUtils.batchDel("user:1", "user:2", "user:3");

// 模式删除
CacheUtils.delByPattern("user:*");

// 检查 key 是否存在
boolean exists = CacheUtils.hasKey("user:1");

// SETNX（分布式锁）
boolean success = CacheUtils.setnx("lock:user:1", "1", 120);

// 防止缓存击穿
User user = CacheUtils.cacheAndGet("user:1", 3600, () -> {
    return userMapper.selectByPrimaryKey("1");
});
```

### 3.2 StringCacheUtils（字符串缓存）

```java
// 设置字符串缓存
StringCacheUtils.set("token", "abc123", 1800);

// 获取字符串缓存
String token = StringCacheUtils.get("token");

// 获取整数
Integer count = StringCacheUtils.getInt("count");

// 删除缓存
StringCacheUtils.del("token");

// SETNX
boolean success = StringCacheUtils.setnx("lock:order:1", "1", 60);

// 防止缓存击穿
String config = StringCacheUtils.cacheAndGet("config:system", 3600, () -> {
    return configMapper.selectConfig();
});
```

## 四、缓存 Key 管理

### 4.1 统一定义缓存 Key

```java
// RedisKeys.java
public class RedisKeys {
    /** 缓存前缀 */
    public static final String PREFIX = "akm:";
    
    /** 互斥锁前缀 */
    public static final String NXKEY = "nx:";
    
    /** 用户信息 */
    public static final String USER_INFO = "user:info:";
    
    /** 登录令牌 */
    public static final String TOKEN = "token:";
    
    /** 验证码 */
    public static final String CAPTCHA = "captcha:";
    
    /** 组织机构列表 */
    public static final String SYS_ORG_LIST = "sys:org:list";
}
```

### 4.2 使用缓存 Key

```java
// ✅ 推荐：使用常量 + prefixKey
String key = RedisKeys.USER_INFO + userId;
CacheUtils.set(key, user, 3600);

// ❌ 不推荐：硬编码
CacheUtils.set("user_" + userId, user);
```

## 五、防止缓存击穿

### 5.1 什么是缓存击穿

缓存在某个时间点过期时，恰好有大量并发请求，这些请求会同时访问数据库，可能导致数据库压力过大。

### 5.2 使用互斥锁

```java
// CacheUtils.cacheAndGet 自动使用互斥锁
User user = CacheUtils.cacheAndGet("user:1", 3600, () -> {
    // 只有获取到锁的线程才会执行这里
    // 其他线程会等待并重试
    return userMapper.selectByPrimaryKey("1");
});
```

**原理**：
1. 检查缓存是否存在
2. 不存在时尝试获取互斥锁（SETNX）
3. 获取成功：从数据库加载数据，设置缓存，释放锁
4. 获取失败：等待后重试获取缓存

## 六、缓存配置详解

### 6.1 Redis 连接池配置

```yaml
spring:
  data:
    redis:
      lettuce:
        pool:
          max-active: 8      # 最大活动连接数
          max-idle: 8        # 最大空闲连接数
          min-idle: 0        # 最小空闲连接数
          max-wait: -1ms     # 最大等待时间
        shutdown-timeout: 100ms
```

### 6.2 Redis 集群配置

```yaml
spring:
  data:
    redis:
      cluster:
        nodes:
          - 192.168.1.1:6379
          - 192.168.1.2:6379
          - 192.168.1.3:6379
        max-redirects: 3
```

### 6.3 Redis Sentinel 配置

```yaml
spring:
  data:
    redis:
      sentinel:
        master: mymaster
        nodes:
          - 192.168.1.1:26379
          - 192.168.1.2:26379
          - 192.168.1.3:26379
```

## 七、缓存最佳实践

### 7.1 合理设置过期时间

```java
// 热点数据：较长过期时间
CacheUtils.set("hot:data", data, 3600 * 24); // 24小时

// 临时数据：较短过期时间
CacheUtils.set("temp:data", data, 300); // 5分钟

// 会话数据：根据业务设置
StringCacheUtils.set("session:" + sessionId, token, 1800); // 30分钟
```

### 7.2 缓存粒度

```java
// ✅ 推荐：细粒度缓存
CacheUtils.set("user:info:" + userId, userInfo);
CacheUtils.set("user:roles:" + userId, userRoles);

// ❌ 不推荐：粗粒度缓存
CacheUtils.set("user:" + userId, entireUserData);
```

### 7.3 缓存更新策略

```java
@Service
public class UserService {
    
    // 查询时缓存
    public User getUser(String userId) {
        return CacheUtils.cacheAndGet("user:" + userId, 3600, () -> {
            return userMapper.selectByPrimaryKey(userId);
        });
    }
    
    // 更新时删除缓存
    public void updateUser(User user) {
        userMapper.updateByPrimaryKey(user);
        CacheUtils.del("user:" + user.getId());
    }
    
    // 删除时删除缓存
    public void deleteUser(String userId) {
        userMapper.deleteByPrimaryKey(userId);
        CacheUtils.del("user:" + userId);
    }
}
```

## 八、常见问题

### 问题 1：启动时报 "Unable to connect to Redis"

**原因**：配置了 Redis 但 Redis 服务不可用

**解决方案**：
1. 检查 Redis 服务是否启动
2. 或修改配置使用本地缓存：`akm.cacheType: local`
3. 或启用 Redis 健康检查禁用：
```yaml
management:
  health:
    redis:
      enabled: false
```

### 问题 2：缓存未生效

**排查步骤**：
1. 检查 `akm.cacheType` 配置
2. 查看启动日志：`>> using REDIS as cache` 或 `>> using LOCAL memory as cache`
3. 检查 Redis 连接是否正常
4. 验证缓存 Key 是否正确

### 问题 3：本地缓存占用内存过大

**解决方案**：
1. 使用 Redis 缓存
2. 减少缓存数据量
3. 设置合理的过期时间
4. 定期清理无用缓存

## 九、监控和诊断

### 9.1 查看缓存配置

```bash
curl http://localhost:33000/demo/config/open/info
```

### 9.2 查看 Redis 状态

```bash
# 进入 Redis CLI
redis-cli

# 查看所有 Key
KEYS akm:*

# 查看 Key 数量
DBSIZE

# 查看内存使用
INFO memory

# 查看连接数
INFO clients
```

### 9.3 本地缓存监控

```java
// LocalCacheStorage 会自动清理过期数据（每10秒）
// 无需手动清理
```

## 十、配置示例

### 开发环境

```yaml
# application-dev.yaml
akm:
  cacheType: local  # 使用本地缓存

# 不配置 Redis
```

### 测试环境

```yaml
# application-test.yaml
akm:
  cacheType: redis

spring:
  data:
    redis:
      host: redis-test.example.com
      port: 6379
      password: ENC(加密的密码)
      database: 1
```

### 生产环境

```yaml
# application-prod.yaml
akm:
  cacheType: redis

spring:
  data:
    redis:
      cluster:
        nodes:
          - redis1.example.com:6379
          - redis2.example.com:6379
          - redis3.example.com:6379
      password: ENC(加密的密码)
      database: 0
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 5
```

## 相关文档

- [开发规范](./开发规范.md)
- [配置中心](./配置中心.md)
- [常见问题](./常见问题.md)

