# Minio 文件存储配置

## 一、Minio 简介

Minio 是一个高性能的分布式对象存储服务，兼容 Amazon S3 API。

**优势**：
- ✅ 开源免费
- ✅ 部署简单
- ✅ 高性能
- ✅ 支持分布式
- ✅ S3 兼容

## 二、Minio 安装

### 2.1 Docker 安装（推荐）

```bash
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minio" \
  -e "MINIO_ROOT_PASSWORD=Minio@1234" \
  -v /data/minio:/data \
  minio/minio server /data --console-address ":9001"
```

访问控制台：http://localhost:9001

### 2.2 二进制安装

```bash
# 下载
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio

# 启动
export MINIO_ROOT_USER=minio
export MINIO_ROOT_PASSWORD=Minio@1234
./minio server /data --console-address ":9001"
```

### 2.3 创建存储桶

1. 登录控制台：http://localhost:9001
2. 用户名：`minio`，密码：`Minio@1234`
3. 点击 "Buckets" → "Create Bucket"
4. 输入桶名称：`akm-1`
5. 点击 "Create Bucket"

## 三、应用配置

### 3.1 配置文件

```yaml
minio:
  endpoint: http://127.0.0.1:9001        # MinIO 服务内网地址（应用上传）
  publicEndpoint: http://127.0.0.1:9001  # 外网访问地址（文件下载）
  accessKey: minio                        # 访问密钥
  secretKey: Minio@1234                   # 访问秘钥
  bucketName: akm-1                       # 存储桶名称
  # 允许上传的文件类型
  allowType: jpg|jpeg|png|gif|webp|tif|bmp|dwg|pdf|docx|doc|xlsx|xls|ppt|pptx|zip
```

### 3.2 Nginx 代理（生产环境）

```nginx
server {
    listen 80;
    server_name files.example.com;

    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:9001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

配置示例：
```yaml
minio:
  endpoint: http://127.0.0.1:9001           # 内网地址
  publicEndpoint: https://files.example.com  # 外网访问地址（Nginx）
```

## 四、文件操作

### 4.1 文件上传

```java
@Operation(summary = "文件上传")
@PostMapping("/upload")
public String upload(@RequestParam("file") MultipartFile file) {
    // 获取原始文件名
    String originalFilename = file.getOriginalFilename();
    
    // 生成存储路径
    String objectKey = FileUtils.genFileKey(originalFilename);
    
    // 上传文件
    MinioUtils.putObject(
        objectKey,
        file.getInputStream(),
        file.getSize(),
        file.getContentType()
    );
    
    return objectKey;
}
```

### 4.2 文件下载

```java
@Operation(summary = "文件下载")
@GetMapping("/download")
public void download(@RequestParam String objectKey, HttpServletResponse response) {
    // 验证文件路径
    if (FileUtils.isInvalidKey(allowType, objectKey)) {
        throw new BusinessException("文件路径无效");
    }
    
    // 获取文件
    GetObjectResponse obj = MinioUtils.getObject(objectKey);
    
    // 设置响应头
    response.setContentType(obj.headers().get("Content-Type"));
    response.setHeader("Content-Disposition", 
        "attachment; filename=" + FileUtils.getFileName(objectKey));
    
    // 输出文件流
    IoUtil.copy(obj, response.getOutputStream());
}
```

### 4.3 获取预签名URL

```java
@Operation(summary = "获取文件预览URL")
@PostMapping("/getFileUrl")
public String getFileUrl(@RequestBody String objectKey) {
    // 验证文件路径
    if (FileUtils.isInvalidKey(allowType, objectKey)) {
        throw new BusinessException("文件路径无效");
    }
    
    // 生成预签名 URL（有效期 5 分钟）
    return MinioUtils.getDownloadPresignedObjectUrl(objectKey, 300);
}
```

## 五、文件工具类

### 5.1 生成文件路径

```java
// 生成带日期的文件路径
String objectKey = FileUtils.genFileKey("photo.jpg");
// 返回：2024/01/15/20240115123456_abc123.jpg
```

### 5.2 验证文件类型

```java
// 检查文件类型是否允许
String allowType = "jpg|png|pdf";
boolean isValid = !FileUtils.isInvalidKey(allowType, "test.jpg");  // true
boolean isValid2 = !FileUtils.isInvalidKey(allowType, "test.exe"); // false
```

### 5.3 格式化文件路径

```java
// 格式化路径（去除前缀斜杠）
String formatted = FileUtils.formatKey("/path/to/file.jpg");
// 返回：path/to/file.jpg
```

## 六、前端集成

### 6.1 上传示例

```javascript
// 文件上传
async function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  
  const response = await fetch('/file/upload', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer ' + token
    },
    body: formData
  });
  
  const objectKey = await response.text();
  return objectKey;
}
```

### 6.2 获取预览URL

```javascript
// 获取文件预览 URL
async function getFileUrl(objectKey) {
  const response = await fetch('/file/getFileUrl', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify(objectKey)
  });
  
  const url = await response.text();
  return url;
}

// 使用示例
const url = await getFileUrl('2024/01/15/20240115123456_abc123.jpg');
window.open(url, '_blank');
```

### 6.3 下载文件

```javascript
// 下载文件
function downloadFile(objectKey, filename) {
  const url = `/file/download?objectKey=${encodeURIComponent(objectKey)}`;
  
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
}
```

## 七、安全配置

### 7.1 文件类型限制

```yaml
minio:
  # 只允许特定类型文件上传
  allowType: jpg|jpeg|png|gif|pdf|doc|docx|xls|xlsx
```

### 7.2 文件大小限制

```yaml
spring:
  servlet:
    multipart:
      max-file-size: 50MB      # 单个文件大小
      max-request-size: 100MB  # 整个请求大小
```

### 7.3 路径验证

```java
// 防止路径遍历攻击
if (FileUtils.isInvalidKey(allowType, objectKey)) {
    throw new BusinessException("文件路径无效");
}
```

## 八、最佳实践

### 8.1 文件命名规范

```java
// ✅ 推荐：使用日期分类 + 随机ID
// 格式：yyyy/MM/dd/yyyyMMddHHmmss_randomId.ext
String objectKey = FileUtils.genFileKey("photo.jpg");
// 结果：2024/01/15/20240115123456_abc123.jpg

// ❌ 不推荐：直接使用原文件名
String objectKey = originalFilename;
```

**优势**：
- 避免文件名冲突
- 方便按日期管理
- 便于数据清理

### 8.2 异步上传

```java
@Async
public CompletableFuture<String> uploadAsync(MultipartFile file) {
    String objectKey = FileUtils.genFileKey(file.getOriginalFilename());
    MinioUtils.putObject(objectKey, file.getInputStream(), 
                        file.getSize(), file.getContentType());
    return CompletableFuture.completedFuture(objectKey);
}
```

### 8.3 文件清理

```java
// 删除过期文件
@Scheduled(cron = "0 0 2 * * ?")  // 每天凌晨 2 点执行
public void cleanExpiredFiles() {
    // 删除 30 天前的临时文件
    String prefix = "temp/" + DateUtil.format(
        DateUtil.offsetDay(new Date(), -30), "yyyy/MM/dd"
    );
    // 实现清理逻辑
}
```

## 九、性能优化

### 9.1 分片上传（大文件）

```java
// 大文件使用分片上传
@PostMapping("/uploadLarge")
public String uploadLarge(@RequestParam("file") MultipartFile file) {
    // Minio 自动处理分片上传
    // 文件大于 5MB 时自动使用分片
    return uploadService.upload(file);
}
```

### 9.2 断点续传

可以使用 Minio 的 Multipart Upload API 实现断点续传。

### 9.3 CDN 加速

在生产环境，建议使用 CDN 加速文件访问：

```yaml
minio:
  endpoint: http://internal-minio:9001
  publicEndpoint: https://cdn.example.com  # CDN 域名
```

## 十、常见问题

### 问题 1：上传失败

**排查步骤**：
1. 检查 Minio 服务是否启动
2. 检查存储桶是否存在
3. 检查 accessKey 和 secretKey
4. 检查网络连接
5. 查看应用日志

### 问题 2：下载 URL 无法访问

**原因**：
- `publicEndpoint` 配置错误
- URL 已过期
- 存储桶权限设置

**解决方案**：
```yaml
minio:
  # 确保 publicEndpoint 可以从外网访问
  publicEndpoint: https://files.example.com
```

### 问题 3：文件类型不允许

**错误信息**：文件下载失败，路径无效或文件类型不允许

**解决方案**：
```yaml
minio:
  # 添加允许的文件类型
  allowType: jpg|jpeg|png|pdf|zip
```

## 十一、监控和维护

### 11.1 查看存储使用情况

登录 Minio 控制台：
1. 访问：http://localhost:9001
2. 点击 "Buckets" → 选择桶
3. 查看 "Usage" 标签页

### 11.2 设置生命周期

```bash
# 使用 mc 工具设置生命周期
mc ilm add myminio/akm-1 \
  --expiry-days 30 \
  --prefix "temp/"
```

### 11.3 备份策略

```bash
# 使用 mc 工具同步备份
mc mirror myminio/akm-1 backup/akm-1
```

## 相关文档

- [开发规范](./开发规范.md)
- [API 开发指南](./API开发指南.md)
- [常见问题](./常见问题.md)

