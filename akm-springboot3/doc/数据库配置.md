# 数据库配置说明

## 一、支持的数据库

- **MySQL 8.0+** (推荐)
- **PostgreSQL 14+**
- **DaMeng 8.1+** (达梦国产数据库)

## 二、MySQL 配置

### 2.1 配置文件

```yaml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/akm_springboot?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: your_password  # 建议使用 Jasypt 加密
    driver-class-name: com.mysql.cj.jdbc.Driver
    
    # HikariCP 连接池配置
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 600000
      max-lifetime: 1800000
      connection-timeout: 30000
```

### 2.2 创建数据库

```sql
CREATE DATABASE akm_springboot 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 2.3 执行脚本

1. 获取 SQL 脚本文件（请联系管理员）
2. 使用 Navicat 或命令行执行脚本

```bash
mysql -u root -p akm_springboot < akm_springboot.sql
```

## 三、PostgreSQL 配置

### 3.1 配置文件

```yaml
spring:
  datasource:
    url: jdbc:postgresql://127.0.0.1:5432/akm_springboot?currentSchema=public
    username: postgres
    password: your_password
    driver-class-name: org.postgresql.Driver
```

### 3.2 从 MySQL 迁移

1. 使用 Navicat 的数据传输功能
2. 或使用 pgloader 工具

```bash
# 使用 pgloader
pgloader mysql://user:pass@localhost/akm_springboot \
          postgresql://user:pass@localhost/akm_springboot
```

### 3.3 注意事项

- PostgreSQL 对大小写敏感
- 部分 MySQL 特有函数需要调整
- 日期函数有差异

## 四、DaMeng (达梦) 配置

### 4.1 配置文件

```yaml
spring:
  datasource:
    url: jdbc:dm://127.0.0.1:5236/akm_springboot
    username: SYSDBA
    password: your_password
    driver-class-name: dm.jdbc.driver.DmDriver
```

### 4.2 从 MySQL 迁移

使用达梦数据迁移工具（DTS）：
1. 下载达梦 DTS 工具
2. 配置源数据库（MySQL）和目标数据库（DaMeng）
3. 选择迁移模式（结构+数据）
4. 执行迁移
5. 验证数据

### 4.3 注意事项

- 达梦默认用户名为大写
- 部分 MySQL 函数需要适配
- 建议使用达梦最新版本

## 五、MyBatis 配置

### 5.1 基础配置

```yaml
mybatis:
  configuration:
    map-underscore-to-camel-case: true  # 下划线转驼峰
    cache-enabled: true                  # 二级缓存
    lazy-loading-enabled: true           # 延迟加载
  mapper-locations: classpath:mapper/**/*.xml
  type-aliases-package: com.akm.springboot3.web.*.entity

# 分页插件
pagehelper:
  reasonable: true          # 合理化页码
  pageSizeZero: true       # pageSize=0 时返回全部
  supportMethodsArguments: true

# 打印 SQL
akm:
  mybatis:
    printSql: true  # 开发环境开启，生产环境关闭
```

### 5.2 Mapper XML 示例

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.akm.springboot3.web.sys.mapper.SysUserMapper">

    <select id="selectByPrimaryKey" resultType="com.akm.springboot3.web.sys.entity.SysUser">
        SELECT * FROM sys_user WHERE id = #{id}
    </select>

    <select id="findByAll" resultType="com.akm.springboot3.web.sys.entity.SysUser">
        SELECT * FROM sys_user
        WHERE del_flag = '0'
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="status != null and status != ''">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
    </select>

    <insert id="insertSelective">
        INSERT INTO sys_user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">id,</if>
            <if test="username != null">username,</if>
            <if test="password != null">password,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="id != null">#{id},</if>
            <if test="username != null">#{username},</if>
            <if test="password != null">#{password},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateByPrimaryKeySelective">
        UPDATE sys_user
        <set>
            <if test="username != null">username = #{username},</if>
            <if test="password != null">password = #{password},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </set>
        WHERE id = #{id}
    </update>

</mapper>
```

## 六、数据库设计规范

### 6.1 表命名规范

- **系统表**: `sys_` 前缀，如 `sys_user`, `sys_role`
- **业务表**: `biz_` 前缀，如 `biz_order`, `biz_product`
- **全部小写，下划线分隔**

### 6.2 字段命名规范

```sql
-- 主键
id VARCHAR(32) PRIMARY KEY COMMENT '主键ID'

-- 创建信息
create_user_id VARCHAR(32) COMMENT '创建人ID'
create_time DATETIME COMMENT '创建时间'

-- 更新信息
update_user_id VARCHAR(32) COMMENT '更新人ID'
update_time DATETIME COMMENT '更新时间'

-- 逻辑删除
del_flag CHAR(1) DEFAULT '0' COMMENT '删除标志(0:未删除,1:已删除)'

-- 租户ID（多租户）
tenant_id VARCHAR(32) COMMENT '租户ID'

-- 备注
remark VARCHAR(500) COMMENT '备注'
```

### 6.3 索引规范

```sql
-- 主键索引
PRIMARY KEY (id)

-- 唯一索引
UNIQUE KEY uk_username (username)

-- 普通索引
KEY idx_create_time (create_time)
KEY idx_status (status)

-- 联合索引（左前缀原则）
KEY idx_tenant_status (tenant_id, status)
```

## 七、连接池配置

### 7.1 HikariCP 配置（推荐）

```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 5              # 最小空闲连接数
      maximum-pool-size: 20        # 最大连接数
      idle-timeout: 600000         # 空闲连接超时时间(ms)
      max-lifetime: 1800000        # 连接最大存活时间(ms)
      connection-timeout: 30000    # 连接超时时间(ms)
      connection-test-query: SELECT 1  # 测试查询
```

### 7.2 Druid 监控（可选）

如需使用 Druid，添加依赖：

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.2.23</version>
</dependency>
```

配置：

```yaml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    druid:
      initial-size: 5
      max-active: 20
      min-idle: 5
      max-wait: 60000
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        login-username: admin
        login-password: admin
```

访问：http://localhost:33000/druid/index.html

## 八、多数据源配置（可选）

### 8.1 添加依赖

```xml
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
    <version>4.3.1</version>
</dependency>
```

### 8.2 配置多数据源

```yaml
spring:
  datasource:
    dynamic:
      primary: master  # 默认数据源
      datasource:
        master:
          url: jdbc:mysql://localhost:3306/db1
          username: root
          password: password
          driver-class-name: com.mysql.cj.jdbc.Driver
        slave:
          url: jdbc:mysql://localhost:3306/db2
          username: root
          password: password
          driver-class-name: com.mysql.cj.jdbc.Driver
```

### 8.3 使用多数据源

```java
@Service
public class UserService {
    
    @DS("master")  // 使用主库
    public void save(User user) {
        userMapper.insert(user);
    }
    
    @DS("slave")   // 使用从库
    public List<User> list() {
        return userMapper.selectAll();
    }
}
```

## 九、数据库备份

### 9.1 MySQL 备份

```bash
# 备份
mysqldump -u root -p akm_springboot > backup_$(date +%Y%m%d).sql

# 恢复
mysql -u root -p akm_springboot < backup_20240101.sql

# 定时备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -pPassword akm_springboot | gzip > /backup/akm_$DATE.sql.gz
find /backup -name "akm_*.sql.gz" -mtime +7 -delete
```

### 9.2 PostgreSQL 备份

```bash
# 备份
pg_dump -U postgres akm_springboot > backup_$(date +%Y%m%d).sql

# 恢复
psql -U postgres akm_springboot < backup_20240101.sql
```

## 十、常见问题

### 问题 1：连接超时

**原因**：
- 数据库服务未启动
- 网络不通
- 防火墙阻止

**解决方案**：
```bash
# 检查数据库服务
systemctl status mysql

# 检查端口
telnet localhost 3306

# 检查配置
ping 数据库IP
```

### 问题 2：中文乱码

**MySQL 解决方案**：
```sql
-- 查看字符集
SHOW VARIABLES LIKE 'character%';

-- 修改字符集
ALTER DATABASE akm_springboot CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 修改表字符集
ALTER TABLE sys_user CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 问题 3：连接池耗尽

**解决方案**：
1. 增大连接池大小
2. 检查是否有连接泄漏
3. 优化慢SQL
4. 添加连接超时配置

## 十一、性能优化

### 11.1 SQL 优化

```sql
-- ✅ 使用索引
SELECT * FROM sys_user WHERE username = 'admin'

-- ❌ 不使用索引
SELECT * FROM sys_user WHERE YEAR(create_time) = 2024

-- ✅ 使用覆盖索引
SELECT id, username FROM sys_user WHERE status = '1'

-- ❌ 避免 SELECT *
SELECT * FROM sys_user
```

### 11.2 分页优化

```java
// ✅ 使用 PageHelper
PageHelper.startPage(page, size);
List<User> list = userMapper.findByAll(query);

// ❌ 查询所有数据再分页
List<User> allList = userMapper.findAll();
List<User> pageList = allList.subList(start, end);
```

### 11.3 批量操作

```java
// ✅ 批量插入
userMapper.batchInsert(userList);

// ❌ 循环插入
for (User user : userList) {
    userMapper.insert(user);
}
```

## 相关文档

- [开发规范](./开发规范.md)
- [缓存配置](./缓存配置.md)
- [常见问题](./常见问题.md)

