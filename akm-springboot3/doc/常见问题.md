# 常见问题解答 (FAQ)

## 一、启动相关

### 问题 1：启动时报 "Unable to connect to Redis"

**错误信息**：
```
Unable to connect to Redis; nested exception is io.lettuce.core.RedisConnectionException
```

**原因**：
- Redis 服务未启动
- Redis 配置错误
- 使用本地缓存但未禁用 Redis 健康检查

**解决方案**：

**方式 1：使用本地缓存**
```yaml
akm:
  cacheType: local  # 使用本地缓存

# 不配置 spring.data.redis
```

**方式 2：启动 Redis 服务**
```bash
# Docker 启动 Redis
docker run -d -p 6379:6379 --name redis redis:latest

# 或配置 Redis 连接
spring:
  data:
    redis:
      host: 127.0.0.1
      port: 6379
```

**方式 3：禁用 Redis 健康检查**
```yaml
management:
  health:
    redis:
      enabled: false
```

### 问题 2：Spring Cloud 版本不兼容

**错误信息**：
```
Spring Boot [3.5.7] is not compatible with this Spring Cloud release train
```

**解决方案**：
```xml
<!-- pom.xml -->
<properties>
    <spring-cloud.version>2025.0.0</spring-cloud.version>
</properties>
```

版本对应关系：
- Spring Boot 3.5.x → Spring Cloud 2025.0.x
- Spring Boot 3.4.x → Spring Cloud 2024.0.x

### 问题 3：Logback 配置警告

**警告信息**：
```
WARN in ch.qos.logback.core.ConsoleAppender[STDOUT] - This appender no longer admits a layout as a sub-component, set an encoder instead.
WARN in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP - Direct use of SizeAndTimeBasedFNATP is deprecated. Please use SizeAndTimeBasedRollingPolicy instead.
```

**原因**：
从 Spring Boot 2 迁移到 Spring Boot 3 时，Logback 版本升级，部分 API 已弃用：
1. `<layout>` 已弃用，应使用 `<encoder>`
2. `SizeAndTimeBasedFNATP` 已弃用，应使用 `SizeAndTimeBasedRollingPolicy`

**解决方案**：

**修改 1：ConsoleAppender 使用 encoder**

修改前：
```xml
<appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    <layout class="ch.qos.logback.classic.PatternLayout">
        <pattern>${LOG_MSG_COLOR}</pattern>
    </layout>
</appender>
```

修改后：
```xml
<appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
    <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
        <pattern>${LOG_MSG_COLOR}</pattern>
        <charset>UTF-8</charset>
    </encoder>
</appender>
```

**修改 2：RollingFileAppender 使用 SizeAndTimeBasedRollingPolicy**

修改前：
```xml
<appender name="FILE_ALL" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <File>${LOG_HOME}/all_log.log</File>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <FileNamePattern>${LOG_DIR}/all_log%i.log</FileNamePattern>
        <MaxHistory>90</MaxHistory>
        <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
            <maxFileSize>20MB</maxFileSize>
        </timeBasedFileNamingAndTriggeringPolicy>
    </rollingPolicy>
    <layout class="ch.qos.logback.classic.PatternLayout">
        <pattern>${LOG_MSG}</pattern>
    </layout>
</appender>
```

修改后：
```xml
<appender name="FILE_ALL" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <File>${LOG_HOME}/all_log.log</File>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
        <FileNamePattern>${LOG_DIR}/all_log%i.log</FileNamePattern>
        <MaxHistory>90</MaxHistory>
        <maxFileSize>20MB</maxFileSize>
        <totalSizeCap>10GB</totalSizeCap>  <!-- 可选：总大小限制 -->
    </rollingPolicy>
    <encoder class="ch.qos.logback.classic.encoder.PatternLayoutEncoder">
        <pattern>${LOG_MSG}</pattern>
        <charset>UTF-8</charset>
    </encoder>
</appender>
```

**关键变更点**：
1. ✅ `<layout>` → `<encoder>`
2. ✅ `TimeBasedRollingPolicy` + `SizeAndTimeBasedFNATP` → `SizeAndTimeBasedRollingPolicy`
3. ✅ `<timeBasedFileNamingAndTriggeringPolicy>` 中的 `<maxFileSize>` 提升到 `<rollingPolicy>` 层级
4. ✅ 新增 `<totalSizeCap>` 限制所有日志文件总大小（可选）

**参考资源**：
- [Logback Appenders 文档](https://logback.qos.ch/manual/appenders.html#SizeAndTimeBasedRollingPolicy)
- [Logback Encoders 文档](https://logback.qos.ch/manual/encoders.html)

### 问题 4：数据库连接失败

**错误信息**：
```
Communications link failure
```

**排查步骤**：
1. 检查数据库服务是否启动
```bash
# MySQL
systemctl status mysql

# 或测试连接
telnet localhost 3306
```

2. 检查数据库配置
```yaml
spring:
  datasource:
    url: jdbc:mysql://127.0.0.1:3306/akm_springboot
    username: root
    password: your_password
```

3. 检查防火墙和端口
```bash
# 检查端口是否开放
nc -zv localhost 3306
```

### 问题 5：端口被占用

**错误信息**：
```
Port 33000 was already in use
```

**解决方案**：

**方式 1：修改端口**
```yaml
server:
  port: 33001  # 更改为其他端口
```

**方式 2：释放端口**
```bash
# 查找占用进程
lsof -i:33000
# 或
netstat -anp | grep 33000

# 杀死进程
kill -9 [PID]
```

## 二、配置相关

### 问题 6：配置中心连接超时

**错误信息**：
```
Timeout connecting to Spring Cloud Config Server
```

**解决方案**：

**方式 1：禁用 Config Client**
```yaml
# bootstrap.yaml
spring:
  cloud:
    config:
      enabled: false
```

**方式 2：设置快速失败**
```yaml
spring:
  cloud:
    config:
      fail-fast: false  # 连接失败使用本地配置
```

### 问题 7：配置刷新不生效

**原因**：
- Bean 未标注 `@RefreshScope`
- 静态代码块中的配置无法刷新
- `@PostConstruct` 初始化的值不会刷新

**解决方案**：

**方式 1：使用 @RefreshScope**
```java
@Component
@RefreshScope
public class MyConfig {
    @Value("${my.config}")
    private String config;
}
```

**方式 2：使用 @ConfigurationProperties**
```java
@Component
@ConfigurationProperties(prefix = "akm")
@Getter
@Setter
public class AkmProperties {
    private String cacheType;
    // 自动刷新，不需要 @RefreshScope
}
```

### 问题 8：Jasypt 解密失败

**错误信息**：
```
Failed to decrypt property
```

**解决方案**：
```yaml
# 检查加密密码是否正确
jasypt:
  encryptor:
    password: 123456  # 必须与加密时使用的密码一致

# 或通过命令行指定
java -jar app.jar --jasypt.encryptor.password=123456
```

## 三、缓存相关

### 问题 9：缓存未生效

**排查步骤**：
1. 检查 `akm.cacheType` 配置
2. 查看启动日志确认缓存类型
```
>> using REDIS as cache
或
>> using LOCAL memory as cache
```

3. 验证缓存 Key
```java
String key = RedisKeys.USER_INFO + userId;
log.info("Cache key: {}", CacheUtils.prefixKey(key));
```

### 问题 10：Redis 序列化错误

**错误信息**：
```
Could not read JSON
```

**原因**：
- 对象未实现 Serializable
- Jackson 版本不兼容
- 类结构变化

**解决方案**：
```java
// 实体类实现 Serializable
@Getter
@Setter
public class User implements Serializable {
    private static final long serialVersionUID = 1L;
    // ...
}
```

### 问题 11：本地缓存内存占用过大

**解决方案**：
1. 使用 Redis 缓存
2. 设置合理的过期时间
3. 定期清理无用缓存

```yaml
akm:
  cacheType: redis  # 切换到 Redis
```

## 四、数据库相关

### 问题 12：SQL 语法错误

**错误信息**：
```
You have an error in your SQL syntax
```

**常见原因**：
1. 关键字未加反引号
```sql
-- ❌ 错误
SELECT user FROM sys_user

-- ✅ 正确
SELECT `user` FROM sys_user
```

2. 使用了不同数据库的特定函数

### 问题 13：中文乱码

**MySQL 解决方案**：
```sql
-- 查看字符集
SHOW VARIABLES LIKE 'character%';

-- 设置字符集
ALTER DATABASE akm_springboot 
CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

ALTER TABLE sys_user 
CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**配置文件**：
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/akm_springboot?characterEncoding=UTF-8
```

### 问题 14：分页查询不生效

**原因**：
- PageHelper 未生效
- 查询方法返回类型错误

**解决方案**：
```java
// ✅ 正确写法
PageHelper.startPage(page, size);
List<User> list = userMapper.findByAll(query);
return PageResult.of(list);

// ❌ 错误写法
List<User> list = userMapper.findByAll(query);
PageHelper.startPage(page, size);  // 顺序错误
```

## 五、文件相关

### 问题 15：Minio 连接失败

**错误信息**：
```
Unable to connect to Minio
```

**排查步骤**：
1. 检查 Minio 服务
```bash
docker ps | grep minio
```

2. 检查配置
```yaml
minio:
  endpoint: http://127.0.0.1:9001
  accessKey: minio
  secretKey: Minio@1234
```

3. 测试访问控制台
```
http://localhost:9001
```

### 问题 16：文件上传失败

**常见原因**：
1. 文件大小超限
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 50MB      # 增大限制
      max-request-size: 100MB
```

2. 文件类型不允许
```yaml
minio:
  allowType: jpg|png|pdf|zip  # 添加允许的类型
```

3. 存储桶不存在
- 登录 Minio 控制台创建存储桶

### 问题 17：文件下载 URL 无效

**原因**：
- URL 已过期（默认 5 分钟）
- publicEndpoint 配置错误

**解决方案**：
```yaml
minio:
  publicEndpoint: https://files.example.com  # 确保可外网访问
```

```java
// 增加有效期
MinioUtils.getDownloadPresignedObjectUrl(objectKey, 3600);  // 1小时
```

## 六、权限相关

### 问题 18：接口返回 403 Forbidden

**原因**：
- 未登录
- 无权限访问
- Token 失效

**排查步骤**：
1. 检查是否登录
2. 检查用户角色权限
3. 检查 Token 是否有效
4. 查看接口权限配置

```yaml
akm:
  enabledAuth: true  # 权限校验是否启用
```

### 问题 19：开放接口也需要权限

**原因**：
- 路径不包含 `/open/`
- 配置的开放路径不正确

**解决方案**：
```java
// 使用 /open/ 路径
@GetMapping("/open/config")
public Config getConfig() {
    // ...
}
```

或配置开放路径：
```yaml
akm:
  openUrls:
    - /auth/login
    - /auth/register
```

## 七、性能相关

### 问题 20：接口响应慢

**排查步骤**：
1. 检查 SQL 性能
```yaml
akm:
  mybatis:
    printSql: true  # 打印 SQL
```

2. 添加索引
3. 使用缓存
4. 优化查询逻辑

### 问题 21：内存占用过高

**排查步骤**：
1. 检查本地缓存
2. 检查是否有内存泄漏
3. 调整 JVM 参数

```bash
java -Xms512m -Xmx1024m -jar app.jar
```

## 八、开发相关

### 问题 22：热部署不生效

**解决方案**：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-devtools</artifactId>
    <scope>runtime</scope>
    <optional>true</optional>
</dependency>
```

IDEA 设置：
1. Settings → Build → Compiler → Build project automatically
2. Settings → Advanced Settings → Allow auto-make to start

### 问题 22：Swagger 文档无法访问

**检查配置**：
```yaml
springdoc:
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /doc.html
```

访问：http://localhost:33000/doc.html

### 问题 23：跨域问题

**解决方案**：
```yaml
akm:
  enabledCorsAllow: true
  corsAllowDomain:
    - http://localhost:8080
    - https://your-domain.com
```

## 九、部署相关

### 问题 24：生产环境配置

**最佳实践**：
```yaml
# application-prod.yaml
akm:
  cacheType: redis  # 使用 Redis
  enabledAuth: true  # 启用权限
  
spring:
  data:
    redis:
      host: redis-prod.example.com
      
logging:
  level:
    root: warn  # 生产环境降低日志级别
    com.akm.springboot3: info
```

### 问题 25：如何查看日志

```bash
# 实时查看日志
tail -f logs/spring.log

# 搜索错误日志
grep "ERROR" logs/spring.log

# 查看最近 100 行
tail -n 100 logs/spring.log
```

## 十、其他问题

### 问题 26：Magic API 无法访问

访问：http://localhost:33000/magic/web/index.html

默认账号：
- 用户名：magic
- 密码：Magic@1234

### 问题 27：如何修改端口

```yaml
server:
  port: 8080  # 修改为其他端口
```

### 问题 28：如何切换数据库

参见：[数据库配置文档](./数据库配置.md)

### 问题 29：如何集成新功能

参见：
- [开发规范](./开发规范.md)
- [API 开发指南](./API开发指南.md)

### 问题 30：如何提交问题

1. 查看日志：`logs/spring.log`
2. 收集错误信息
3. 提供复现步骤
4. 提交 Issue

## 获取帮助

如果以上问题都无法解决您的问题，请：

1. 查看完整文档：[doc](../) 目录
2. 查看日志文件：`logs/spring.log`
3. 提交 Issue
4. 联系技术支持

## 相关文档

- [开发规范](./开发规范.md)
- [配置中心](./配置中心.md)
- [配置刷新](./配置刷新.md)
- [数据库配置](./数据库配置.md)
- [缓存配置](./缓存配置.md)
- [文件存储](./文件存储.md)
- [API开发指南](./API开发指南.md)

