# Spring Cloud Config 配置说明

## 一、配置概览

本项目已集成 Spring Cloud Config Client，可从配置中心获取配置。

### 配置文件说明
- **bootstrap.yaml**: Config Server 连接配置（最高优先级）
- **application.yaml**: 基础配置
- **application-dev.yaml**: 开发环境配置（本地备用）

### 配置加载顺序
1. **Config Server 配置**（优先级最高）
2. bootstrap.yaml
3. application-{profile}.yaml
4. application.yaml

## 二、Config Server 配置要求

### 1. Config Server 端配置

在你的 Config Server 中，需要提供以下配置文件：

```
配置文件路径示例（Git 仓库或文件系统）:
├── akm-springboot3.yaml          # 基础配置
├── akm-springboot3-dev.yaml      # 开发环境配置
└── akm-springboot3-prod.yaml     # 生产环境配置
```

**配置内容应与 `application-dev.yaml` 保持一致**

### 2. Config Server 地址

当前配置的 Config Server 地址：
- **URI**: `http://localhost:33033`
- **应用名**: `akm-springboot3`
- **环境**: `dev`
- **完整路径**: `http://localhost:33033/akm-springboot3/dev`

## 三、启动配置

### 方式 1：启用 Config Client（默认）

确保 `bootstrap.yaml` 中配置：

```yaml
spring:
  cloud:
    config:
      enabled: true  # 启用 Config Client
      uri: http://localhost:33033
```

### 方式 2：禁用 Config Client（使用本地配置）

修改 `bootstrap.yaml`：

```yaml
spring:
  cloud:
    config:
      enabled: false  # 禁用 Config Client
```

或在启动时指定参数：

```bash
java -jar akm-springboot3.jar --spring.cloud.config.enabled=false
```

### 方式 3：指定不同的 Config Server

启动时覆盖配置：

```bash
java -jar akm-springboot3.jar \
  --spring.cloud.config.uri=http://your-config-server:8888
```

## 四、验证配置

### 1. 查看启动日志

应用启动时会打印 Config 信息：

```
========================================
Spring Cloud Config 配置信息:
Config Server URI: http://localhost:33033
Application Name: akm-springboot3
Active Profile: dev
✅ 成功从 Config Server 获取配置: Config resource 'http://localhost:33033/akm-springboot3/dev'
缓存类型 (akm.cacheType): local
========================================
```

### 2. 访问测试接口

访问以下接口验证配置：

```bash
# 查看配置信息
curl http://localhost:33000/demo/config/open/info

# 响应示例
{
  "configServerUri": "http://localhost:33033",
  "applicationName": "akm-springboot3",
  "activeProfile": "dev",
  "fromConfigServer": true,
  "sampleConfigs": {
    "akm.cacheType": "local",
    "akm.enabledAuth": "true",
    "spring.datasource.url": "jdbc:mysql://127.0.0.1:3306/akm_springboot?..."
  }
}
```

### 3. 查看 Swagger 文档

访问：http://localhost:33000/doc.html

查找 **配置中心测试** 分类下的接口

## 五、配置刷新（动态更新）

### 1. 添加 Actuator 依赖（可选）

在 `pom.xml` 中添加：

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

### 2. 启用 refresh 端点

在 `application.yaml` 中添加：

```yaml
management:
  endpoints:
    web:
      exposure:
        include: refresh,health,info
```

### 3. 刷新配置

修改 Config Server 中的配置后，执行：

```bash
curl -X POST http://localhost:33000/actuator/refresh
```

**注意**：只有标注了 `@RefreshScope` 的 Bean 才会动态刷新

## 六、故障处理

### 问题 1：连接不到 Config Server

**现象**：启动缓慢或失败

**解决方案**：
1. 设置 `spring.cloud.config.fail-fast=false`（已配置）
2. 或禁用 Config Client：`spring.cloud.config.enabled=false`

### 问题 2：配置未生效

**排查步骤**：
1. 检查启动日志是否显示 "✅ 成功从 Config Server 获取配置"
2. 访问 `/demo/config/open/info` 查看 `fromConfigServer` 是否为 true
3. 检查 Config Server 中配置文件名称是否正确：
   - 应用名：`akm-springboot3`
   - 环境：`dev`
   - 文件名：`akm-springboot3-dev.yaml` 或 `akm-springboot3-dev.properties`

### 问题 3：配置文件格式错误

**注意事项**：
- Config Server 返回的配置必须是有效的 YAML 或 Properties 格式
- 密码等敏感信息需要加密（使用 Jasypt）
- 配置内容应与 `application-dev.yaml` 保持一致

## 七、最佳实践

### 1. 敏感信息加密

使用 Jasypt 加密密码：

```bash
# 加密密码
java -cp jasypt-1.9.3.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI \
  input="your-password" password=123456 algorithm=PBEWithMD5AndDES
```

在配置文件中使用：

```yaml
spring:
  datasource:
    password: ENC(加密后的密码)
```

### 2. 多环境配置

```
Config Server 配置结构：
├── akm-springboot3.yaml          # 所有环境通用配置
├── akm-springboot3-dev.yaml      # 开发环境
├── akm-springboot3-test.yaml     # 测试环境
└── akm-springboot3-prod.yaml     # 生产环境
```

### 3. 配置优先级

```
Config Server 配置 > bootstrap.yaml > application-{profile}.yaml > application.yaml
```

### 4. 本地开发建议

- 开发环境可禁用 Config Client，使用本地配置文件
- 测试和生产环境启用 Config Client，统一管理配置
- 本地配置文件作为备用，防止 Config Server 不可用

## 八、依赖版本

```xml
<spring-cloud.version>2025.0.0</spring-cloud.version>
```

- Spring Boot: 3.5.7
- Spring Cloud: 2025.0.0 (Kilburn)
- Java: 17

## 九、参考链接

- [Spring Cloud Config 官方文档](https://docs.spring.io/spring-cloud-config/docs/current/reference/html/)
- [Spring Boot 配置加载顺序](https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config)

